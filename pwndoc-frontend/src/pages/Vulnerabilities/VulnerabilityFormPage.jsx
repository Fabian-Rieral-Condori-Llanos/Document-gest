import { useEffect, useState } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { useNavigate, useParams } from 'react-router-dom';
import {
  fetchVulnerabilityById,
  fetchVulnerabilityCategories,
  fetchVulnerabilityTypes,
  fetchLanguages,
  createVulnerability,
  updateVulnerability,
  selectSelectedVulnerability,
  selectVulnerabilitiesLoading,
  selectVulnerabilitiesError,
  selectVulnerabilityCategories,
  selectVulnerabilityTypes,
  selectLanguages,
  clearSelectedVulnerability,
  clearError,
  PRIORITY_MAP,
  COMPLEXITY_MAP,
} from '../../features/vulnerabilities';
import Card from '../../components/common/Card/Card';
import Button from '../../components/common/Button/Button';
import Alert from '../../components/common/Alert/Alert';
import { CVSSInput } from '../../components/common/CVSSCalculator';
import {
  Shield,
  ArrowLeft,
  Save,
  Plus,
  Trash2,
  Globe,
  FileText,
  Link as LinkIcon,
  Wrench,
  X,
} from 'lucide-react';

/**
 * VulnerabilityFormPage - Crear o editar vulnerabilidad
 */
const VulnerabilityFormPage = () => {
  const dispatch = useDispatch();
  const navigate = useNavigate();
  const { id } = useParams();

  const isEditMode = Boolean(id);

  // Redux state
  const selectedVuln = useSelector(selectSelectedVulnerability);
  const categories = useSelector(selectVulnerabilityCategories);
  const vulnTypes = useSelector(selectVulnerabilityTypes);
  const languages = useSelector(selectLanguages);
  const loading = useSelector(selectVulnerabilitiesLoading);
  const error = useSelector(selectVulnerabilitiesError);

  // Form state
  const [formData, setFormData] = useState({
    cvssv3: '',
    cvssv4: '',
    priority: '',
    remediationComplexity: '',
    category: '',
    details: [
      {
        locale: 'es',
        title: '',
        vulnType: '',
        description: '',
        observation: '',
        remediation: '',
        references: [''],
      }
    ],
  });

  const [activeLocale, setActiveLocale] = useState('es');
  const [validationErrors, setValidationErrors] = useState({});
  const [successMessage, setSuccessMessage] = useState('');

  // Cargar datos auxiliares al montar
  useEffect(() => {
    dispatch(fetchVulnerabilityCategories());
    dispatch(fetchVulnerabilityTypes());
    dispatch(fetchLanguages());

    return () => {
      dispatch(clearSelectedVulnerability());
      dispatch(clearError());
    };
  }, [dispatch]);

  // Cargar vulnerabilidad si estamos en modo edición
  useEffect(() => {
    if (isEditMode && id) {
      dispatch(fetchVulnerabilityById(id));
    }
  }, [isEditMode, id, dispatch]);

  // Llenar formulario con datos de la vulnerabilidad
  useEffect(() => {
    if (isEditMode && selectedVuln) {
      setFormData({
        cvssv3: selectedVuln.cvssv3 || '',
        cvssv4: selectedVuln.cvssv4 || '',
        priority: selectedVuln.priority || '',
        remediationComplexity: selectedVuln.remediationComplexity || '',
        category: selectedVuln.category || '',
        details: selectedVuln.details?.map(d => ({
          ...d,
          references: d.references?.length ? d.references : [''],
        })) || [{
          locale: 'es',
          title: '',
          vulnType: '',
          description: '',
          observation: '',
          remediation: '',
          references: [''],
        }],
      });
      
      if (selectedVuln.details?.length > 0) {
        setActiveLocale(selectedVuln.details[0].locale || 'es');
      }
    }
  }, [selectedVuln, isEditMode]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
    
    if (validationErrors[name]) {
      setValidationErrors(prev => ({ ...prev, [name]: '' }));
    }
  };

  const handleCvssv3Change = (value) => {
    setFormData(prev => ({ ...prev, cvssv3: value }));
  };

  const handleCvssv4Change = (value) => {
    setFormData(prev => ({ ...prev, cvssv4: value }));
  };

  const handleDetailChange = (locale, field, value) => {
    setFormData(prev => ({
      ...prev,
      details: prev.details.map(d => 
        d.locale === locale ? { ...d, [field]: value } : d
      ),
    }));
  };

  const handleReferenceChange = (locale, index, value) => {
    setFormData(prev => ({
      ...prev,
      details: prev.details.map(d => {
        if (d.locale === locale) {
          const newRefs = [...d.references];
          newRefs[index] = value;
          return { ...d, references: newRefs };
        }
        return d;
      }),
    }));
  };

  const addReference = (locale) => {
    setFormData(prev => ({
      ...prev,
      details: prev.details.map(d => 
        d.locale === locale 
          ? { ...d, references: [...d.references, ''] }
          : d
      ),
    }));
  };

  const removeReference = (locale, index) => {
    setFormData(prev => ({
      ...prev,
      details: prev.details.map(d => {
        if (d.locale === locale && d.references.length > 1) {
          const newRefs = d.references.filter((_, i) => i !== index);
          return { ...d, references: newRefs };
        }
        return d;
      }),
    }));
  };

  const addLocale = (locale) => {
    if (formData.details.find(d => d.locale === locale)) return;
    
    setFormData(prev => ({
      ...prev,
      details: [
        ...prev.details,
        {
          locale,
          title: '',
          vulnType: '',
          description: '',
          observation: '',
          remediation: '',
          references: [''],
        }
      ],
    }));
    setActiveLocale(locale);
  };

  const removeLocale = (locale) => {
    if (formData.details.length <= 1) return;
    
    setFormData(prev => ({
      ...prev,
      details: prev.details.filter(d => d.locale !== locale),
    }));
    
    if (activeLocale === locale) {
      const remaining = formData.details.filter(d => d.locale !== locale);
      setActiveLocale(remaining[0]?.locale || 'es');
    }
  };

  const getCurrentDetail = () => {
    return formData.details.find(d => d.locale === activeLocale) || formData.details[0];
  };

  const validate = () => {
    const errors = {};
    const currentDetail = getCurrentDetail();

    if (!currentDetail?.title?.trim()) {
      errors.title = 'El título es requerido';
    }

    setValidationErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!validate()) return;

    try {
      // Limpiar referencias vacías
      const cleanedData = {
        ...formData,
        details: formData.details.map(d => ({
          ...d,
          references: d.references.filter(r => r.trim()),
        })),
      };

      if (isEditMode) {
        await dispatch(updateVulnerability({ id, vulnData: cleanedData })).unwrap();
        setSuccessMessage('Vulnerabilidad actualizada correctamente');
      } else {
        await dispatch(createVulnerability(cleanedData)).unwrap();
        setSuccessMessage('Vulnerabilidad creada correctamente');
      }

      setTimeout(() => {
        navigate('/vulnerabilities');
      }, 1500);
    } catch (err) {
      console.error('Error:', err);
    }
  };

  const handleBack = () => {
    navigate('/vulnerabilities');
  };

  const currentDetail = getCurrentDetail();
  const availableLocales = languages.filter(
    l => !formData.details.find(d => d.locale === l.locale)
  );

  return (
    <div className="min-h-screen bg-bg-primary p-6 lg:p-8">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="flex items-center gap-4 mb-6">
          <Button variant="ghost" icon={ArrowLeft} onClick={handleBack} />
          <div>
            <h1 className="text-2xl lg:text-3xl font-bold text-white flex items-center gap-3">
              <Shield className="w-8 h-8 text-danger-400" />
              {isEditMode ? 'Editar Vulnerabilidad' : 'Nueva Vulnerabilidad'}
            </h1>
            <p className="text-gray-400 mt-1">
              {isEditMode ? 'Modifica los datos de la vulnerabilidad' : 'Agrega una nueva vulnerabilidad a la base de conocimiento'}
            </p>
          </div>
        </div>

        {/* Alerts */}
        {error && (
          <Alert variant="danger" className="mb-6" onClose={() => dispatch(clearError())}>
            {error}
          </Alert>
        )}

        {successMessage && (
          <Alert variant="success" className="mb-6">
            {successMessage}
          </Alert>
        )}

        {/* Form */}
        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Información General */}
          <Card>
            <h3 className="text-lg font-medium text-white mb-4 flex items-center gap-2">
              <FileText className="w-5 h-5 text-primary-400" />
              Información General
            </h3>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              {/* Categoría */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  Categoría
                </label>
                <select
                  name="category"
                  value={formData.category}
                  onChange={handleChange}
                  className="w-full px-3 py-2.5 bg-bg-tertiary border border-gray-700 rounded-lg text-white focus:outline-none focus:border-primary-500"
                >
                  <option value="">Seleccionar categoría</option>
                  {categories.map(cat => (
                    <option key={cat._id || cat.name} value={cat.name}>
                      {cat.name}
                    </option>
                  ))}
                </select>
              </div>

              {/* Prioridad */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  Prioridad
                </label>
                <select
                  name="priority"
                  value={formData.priority}
                  onChange={handleChange}
                  className="w-full px-3 py-2.5 bg-bg-tertiary border border-gray-700 rounded-lg text-white focus:outline-none focus:border-primary-500"
                >
                  <option value="">Seleccionar prioridad</option>
                  {Object.entries(PRIORITY_MAP).map(([key, val]) => (
                    <option key={key} value={key}>
                      {val.label}
                    </option>
                  ))}
                </select>
              </div>

              {/* Complejidad de remediación */}
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  Complejidad de Remediación
                </label>
                <select
                  name="remediationComplexity"
                  value={formData.remediationComplexity}
                  onChange={handleChange}
                  className="w-full px-3 py-2.5 bg-bg-tertiary border border-gray-700 rounded-lg text-white focus:outline-none focus:border-primary-500"
                >
                  <option value="">Seleccionar complejidad</option>
                  {Object.entries(COMPLEXITY_MAP).map(([key, val]) => (
                    <option key={key} value={key}>
                      {val.label}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* CVSS Input Component */}
            <div className="pt-4 border-t border-gray-700">
              <h4 className="text-md font-medium text-white mb-4">Puntuación CVSS</h4>
              <CVSSInput
                cvssv3={formData.cvssv3}
                cvssv4={formData.cvssv4}
                onCvssv3Change={handleCvssv3Change}
                onCvssv4Change={handleCvssv4Change}
              />
            </div>
          </Card>

          {/* Detalles por idioma */}
          <Card>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-medium text-white flex items-center gap-2">
                <Globe className="w-5 h-5 text-info-400" />
                Detalles
              </h3>

              {/* Selector de idioma */}
              {availableLocales.length > 0 && (
                <div className="flex items-center gap-2">
                  <select
                    onChange={(e) => {
                      if (e.target.value) addLocale(e.target.value);
                      e.target.value = '';
                    }}
                    className="px-3 py-1.5 bg-bg-tertiary border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-primary-500"
                  >
                    <option value="">+ Agregar idioma</option>
                    {availableLocales.map(l => (
                      <option key={l.locale} value={l.locale}>
                        {l.language}
                      </option>
                    ))}
                  </select>
                </div>
              )}
            </div>

            {/* Tabs de idiomas */}
            <div className="flex border-b border-gray-700 mb-4 overflow-x-auto">
              {formData.details.map(detail => {
                const lang = languages.find(l => l.locale === detail.locale);
                return (
                  <button
                    key={detail.locale}
                    type="button"
                    onClick={() => setActiveLocale(detail.locale)}
                    className={`flex items-center gap-2 px-4 py-2 text-sm font-medium border-b-2 -mb-px whitespace-nowrap ${
                      activeLocale === detail.locale
                        ? 'text-primary-400 border-primary-400'
                        : 'text-gray-400 border-transparent hover:text-white'
                    }`}
                  >
                    {lang?.language || detail.locale.toUpperCase()}
                    {formData.details.length > 1 && (
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          removeLocale(detail.locale);
                        }}
                        className="ml-1 text-gray-500 hover:text-danger-400"
                      >
                        <X className="w-3 h-3" />
                      </button>
                    )}
                  </button>
                );
              })}
            </div>

            {/* Campos del idioma activo */}
            <div className="space-y-4">
              {/* Título */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  Título <span className="text-danger-400">*</span>
                </label>
                <input
                  type="text"
                  value={currentDetail?.title || ''}
                  onChange={(e) => handleDetailChange(activeLocale, 'title', e.target.value)}
                  placeholder="Ej: Inyección SQL en parámetro de búsqueda"
                  className={`w-full px-3 py-2.5 bg-bg-tertiary border rounded-lg text-white placeholder-gray-500 focus:outline-none transition-colors ${
                    validationErrors.title ? 'border-danger-500' : 'border-gray-700 focus:border-primary-500'
                  }`}
                />
                {validationErrors.title && (
                  <p className="mt-1 text-sm text-danger-400">{validationErrors.title}</p>
                )}
              </div>

              {/* Tipo de vulnerabilidad */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  Tipo de Vulnerabilidad
                </label>
                <select
                  value={currentDetail?.vulnType || ''}
                  onChange={(e) => handleDetailChange(activeLocale, 'vulnType', e.target.value)}
                  className="w-full px-3 py-2.5 bg-bg-tertiary border border-gray-700 rounded-lg text-white focus:outline-none focus:border-primary-500"
                >
                  <option value="">Seleccionar tipo</option>
                  {vulnTypes.map(type => (
                    <option key={type.name} value={type.name}>
                      {type.name}
                    </option>
                  ))}
                </select>
              </div>

              {/* Descripción */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  Descripción
                </label>
                <textarea
                  value={currentDetail?.description || ''}
                  onChange={(e) => handleDetailChange(activeLocale, 'description', e.target.value)}
                  placeholder="Descripción detallada de la vulnerabilidad..."
                  rows={4}
                  className="w-full px-3 py-2.5 bg-bg-tertiary border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary-500 resize-none"
                />
              </div>

              {/* Observación */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5">
                  Observación / Evidencia
                </label>
                <textarea
                  value={currentDetail?.observation || ''}
                  onChange={(e) => handleDetailChange(activeLocale, 'observation', e.target.value)}
                  placeholder="Observaciones y evidencia encontrada..."
                  rows={3}
                  className="w-full px-3 py-2.5 bg-bg-tertiary border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary-500 resize-none"
                />
              </div>

              {/* Remediación */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5 flex items-center gap-2">
                  <Wrench className="w-4 h-4" />
                  Remediación
                </label>
                <textarea
                  value={currentDetail?.remediation || ''}
                  onChange={(e) => handleDetailChange(activeLocale, 'remediation', e.target.value)}
                  placeholder="Pasos para remediar la vulnerabilidad..."
                  rows={3}
                  className="w-full px-3 py-2.5 bg-bg-tertiary border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary-500 resize-none"
                />
              </div>

              {/* Referencias */}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1.5 flex items-center gap-2">
                  <LinkIcon className="w-4 h-4" />
                  Referencias
                </label>
                <div className="space-y-2">
                  {currentDetail?.references?.map((ref, index) => (
                    <div key={index} className="flex gap-2">
                      <input
                        type="text"
                        value={ref}
                        onChange={(e) => handleReferenceChange(activeLocale, index, e.target.value)}
                        placeholder="https://..."
                        className="flex-1 px-3 py-2 bg-bg-tertiary border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary-500 text-sm"
                      />
                      {currentDetail.references.length > 1 && (
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          icon={Trash2}
                          onClick={() => removeReference(activeLocale, index)}
                          className="text-danger-400"
                        />
                      )}
                    </div>
                  ))}
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    icon={Plus}
                    onClick={() => addReference(activeLocale)}
                  >
                    Agregar referencia
                  </Button>
                </div>
              </div>
            </div>
          </Card>

          {/* Actions */}
          <div className="flex items-center justify-end gap-3">
            <Button type="button" variant="ghost" onClick={handleBack}>
              Cancelar
            </Button>

            <Button type="submit" variant="primary" icon={Save} loading={loading}>
              {isEditMode ? 'Guardar Cambios' : 'Crear Vulnerabilidad'}
            </Button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default VulnerabilityFormPage;