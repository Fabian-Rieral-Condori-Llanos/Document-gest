import { useEffect, useState } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { useNavigate, useParams } from 'react-router-dom';
import {
  fetchVulnerabilityById,
  fetchLanguages,
  deleteVulnerability,
  selectSelectedVulnerability,
  selectVulnerabilitiesLoading,
  selectVulnerabilitiesError,
  selectLanguages,
  clearSelectedVulnerability,
  clearError,
  PRIORITY_MAP,
  COMPLEXITY_MAP,
  STATUS_MAP,
} from '../../features/vulnerabilities';
import Card from '../../components/common/Card/Card';
import Button from '../../components/common/Button/Button';
import Alert from '../../components/common/Alert/Alert';
import {
  Shield,
  ArrowLeft,
  Edit,
  Trash2,
  Globe,
  AlertTriangle,
  ExternalLink,
  Copy,
  Check,
  Wrench,
  FileText,
  Tag,
} from 'lucide-react';

/**
 * VulnerabilityDetailPage - Ver detalles de una vulnerabilidad
 */
const VulnerabilityDetailPage = () => {
  const dispatch = useDispatch();
  const navigate = useNavigate();
  const { id } = useParams();

  // Redux state
  const vulnerability = useSelector(selectSelectedVulnerability);
  const languages = useSelector(selectLanguages);
  const loading = useSelector(selectVulnerabilitiesLoading);
  const error = useSelector(selectVulnerabilitiesError);

  // Local state
  const [activeLocale, setActiveLocale] = useState('es');
  const [deleteModal, setDeleteModal] = useState(false);
  const [copied, setCopied] = useState(false);

  // Cargar datos al montar
  useEffect(() => {
    dispatch(fetchVulnerabilityById(id));
    dispatch(fetchLanguages());

    return () => {
      dispatch(clearSelectedVulnerability());
      dispatch(clearError());
    };
  }, [dispatch, id]);

  // Establecer idioma activo cuando cargue la vulnerabilidad
  useEffect(() => {
    if (vulnerability?.details?.length > 0) {
      setActiveLocale(vulnerability.details[0].locale || 'es');
    }
  }, [vulnerability]);

  const handleBack = () => {
    navigate('/vulnerabilities');
  };

  const handleEdit = () => {
    navigate(`/vulnerabilities/${id}/edit`);
  };

  const handleDeleteConfirm = async () => {
    await dispatch(deleteVulnerability(id));
    navigate('/vulnerabilities');
  };

  const handleCopyCVSS = () => {
    if (vulnerability?.cvssv3) {
      navigator.clipboard.writeText(vulnerability.cvssv3);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  const getCurrentDetail = () => {
    return vulnerability?.details?.find(d => d.locale === activeLocale) || vulnerability?.details?.[0];
  };

  const getPriorityInfo = (priority) => {
    const p = PRIORITY_MAP[priority];
    if (!p) return null;
    
    const colors = {
      danger: 'bg-danger-500/10 text-danger-400 border-danger-500/20',
      warning: 'bg-warning-500/10 text-warning-400 border-warning-500/20',
      info: 'bg-info-500/10 text-info-400 border-info-500/20',
      success: 'bg-primary-500/10 text-primary-400 border-primary-500/20',
    };
    
    return { ...p, className: colors[p.color] };
  };

  const getComplexityInfo = (complexity) => {
    const c = COMPLEXITY_MAP[complexity];
    if (!c) return null;
    
    const colors = {
      success: 'bg-primary-500/10 text-primary-400',
      warning: 'bg-warning-500/10 text-warning-400',
      danger: 'bg-danger-500/10 text-danger-400',
    };
    
    return { ...c, className: colors[c.color] };
  };

  const getStatusInfo = (status) => {
    const s = STATUS_MAP[status];
    if (!s) return null;
    
    const colors = {
      success: 'bg-primary-500/10 text-primary-400',
      info: 'bg-info-500/10 text-info-400',
      warning: 'bg-warning-500/10 text-warning-400',
    };
    
    return { ...s, className: colors[s.color] };
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-12 h-12 border-2 border-danger-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-400">Cargando vulnerabilidad...</p>
        </div>
      </div>
    );
  }

  if (!vulnerability) {
    return (
      <div className="min-h-screen bg-bg-primary p-6 lg:p-8">
        <Card className="max-w-md mx-auto text-center py-12">
          <Shield className="w-16 h-16 text-gray-600 mx-auto mb-4" />
          <h3 className="text-lg font-medium text-white mb-2">
            Vulnerabilidad no encontrada
          </h3>
          <p className="text-gray-400 mb-4">
            La vulnerabilidad solicitada no existe o fue eliminada.
          </p>
          <Button variant="primary" onClick={handleBack}>
            Volver al listado
          </Button>
        </Card>
      </div>
    );
  }

  const currentDetail = getCurrentDetail();
  const priorityInfo = getPriorityInfo(vulnerability.priority);
  const complexityInfo = getComplexityInfo(vulnerability.remediationComplexity);
  const statusInfo = getStatusInfo(vulnerability.status);

  return (
    <div className="min-h-screen bg-bg-primary p-6 lg:p-8">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-4 mb-6">
          <div className="flex items-start gap-4">
            <Button variant="ghost" icon={ArrowLeft} onClick={handleBack} />
            <div>
              <h1 className="text-2xl lg:text-3xl font-bold text-white">
                {currentDetail?.title || 'Sin título'}
              </h1>
              <div className="flex flex-wrap items-center gap-2 mt-2">
                {vulnerability.category && (
                  <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-accent-500/10 text-accent-400 border border-accent-500/20">
                    <Tag className="w-3 h-3 mr-1" />
                    {vulnerability.category}
                  </span>
                )}
                {priorityInfo && (
                  <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${priorityInfo.className}`}>
                    {priorityInfo.label}
                  </span>
                )}
                {statusInfo && (
                  <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${statusInfo.className}`}>
                    {statusInfo.label}
                  </span>
                )}
              </div>
            </div>
          </div>

          <div className="flex items-center gap-2">
            <Button variant="ghost" icon={Edit} onClick={handleEdit}>
              Editar
            </Button>
            <Button
              variant="danger"
              icon={Trash2}
              onClick={() => setDeleteModal(true)}
            >
              Eliminar
            </Button>
          </div>
        </div>

        {/* Error Alert */}
        {error && (
          <Alert variant="danger" className="mb-6" onClose={() => dispatch(clearError())}>
            {error}
          </Alert>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Columna principal */}
          <div className="lg:col-span-2 space-y-6">
            {/* Tabs de idiomas */}
            {vulnerability.details?.length > 1 && (
              <div className="flex border-b border-gray-700 overflow-x-auto">
                {vulnerability.details.map(detail => {
                  const lang = languages.find(l => l.locale === detail.locale);
                  return (
                    <button
                      key={detail.locale}
                      onClick={() => setActiveLocale(detail.locale)}
                      className={`flex items-center gap-2 px-4 py-2 text-sm font-medium border-b-2 -mb-px whitespace-nowrap ${
                        activeLocale === detail.locale
                          ? 'text-primary-400 border-primary-400'
                          : 'text-gray-400 border-transparent hover:text-white'
                      }`}
                    >
                      <Globe className="w-4 h-4" />
                      {lang?.language || detail.locale.toUpperCase()}
                    </button>
                  );
                })}
              </div>
            )}

            {/* Descripción */}
            {currentDetail?.description && (
              <Card>
                <h3 className="text-lg font-medium text-white mb-3 flex items-center gap-2">
                  <FileText className="w-5 h-5 text-info-400" />
                  Descripción
                </h3>
                <div className="prose prose-invert max-w-none">
                  <p className="text-gray-300 whitespace-pre-wrap">
                    {currentDetail.description}
                  </p>
                </div>
              </Card>
            )}

            {/* Observación */}
            {currentDetail?.observation && (
              <Card>
                <h3 className="text-lg font-medium text-white mb-3 flex items-center gap-2">
                  <AlertTriangle className="w-5 h-5 text-warning-400" />
                  Observación / Evidencia
                </h3>
                <div className="prose prose-invert max-w-none">
                  <p className="text-gray-300 whitespace-pre-wrap">
                    {currentDetail.observation}
                  </p>
                </div>
              </Card>
            )}

            {/* Remediación */}
            {currentDetail?.remediation && (
              <Card>
                <h3 className="text-lg font-medium text-white mb-3 flex items-center gap-2">
                  <Wrench className="w-5 h-5 text-primary-400" />
                  Remediación
                </h3>
                <div className="prose prose-invert max-w-none">
                  <p className="text-gray-300 whitespace-pre-wrap">
                    {currentDetail.remediation}
                  </p>
                </div>
              </Card>
            )}

            {/* Referencias */}
            {currentDetail?.references?.length > 0 && currentDetail.references.some(r => r) && (
              <Card>
                <h3 className="text-lg font-medium text-white mb-3 flex items-center gap-2">
                  <ExternalLink className="w-5 h-5 text-accent-400" />
                  Referencias
                </h3>
                <ul className="space-y-2">
                  {currentDetail.references.filter(r => r).map((ref, index) => (
                    <li key={index}>
                      <a
                        href={ref}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-primary-400 hover:text-primary-300 hover:underline flex items-center gap-2 text-sm"
                      >
                        <ExternalLink className="w-4 h-4 flex-shrink-0" />
                        <span className="break-all">{ref}</span>
                      </a>
                    </li>
                  ))}
                </ul>
              </Card>
            )}
          </div>

          {/* Columna lateral */}
          <div className="space-y-6">
            {/* Información técnica */}
            <Card>
              <h3 className="text-lg font-medium text-white mb-4">
                Información Técnica
              </h3>
              
              <div className="space-y-4">
                {/* CVSS */}
                {vulnerability.cvssv3 && (
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">CVSS v3.1</label>
                    <div className="flex items-center gap-2">
                      <code className="flex-1 px-3 py-2 bg-bg-tertiary rounded text-sm text-white font-mono break-all">
                        {vulnerability.cvssv3}
                      </code>
                      <Button
                        variant="ghost"
                        size="sm"
                        icon={copied ? Check : Copy}
                        onClick={handleCopyCVSS}
                        title="Copiar CVSS"
                      />
                    </div>
                  </div>
                )}

                {/* Prioridad */}
                {priorityInfo && (
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">Prioridad</label>
                    <span className={`inline-flex items-center px-3 py-1.5 rounded text-sm font-medium border ${priorityInfo.className}`}>
                      {priorityInfo.label}
                    </span>
                  </div>
                )}

                {/* Complejidad */}
                {complexityInfo && (
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">Complejidad de Remediación</label>
                    <span className={`inline-flex items-center px-3 py-1.5 rounded text-sm font-medium ${complexityInfo.className}`}>
                      {complexityInfo.label}
                    </span>
                  </div>
                )}

                {/* Tipo de vulnerabilidad */}
                {currentDetail?.vulnType && (
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">Tipo</label>
                    <span className="text-white">{currentDetail.vulnType}</span>
                  </div>
                )}
              </div>
            </Card>

            {/* Metadatos */}
            <Card>
              <h3 className="text-lg font-medium text-white mb-4">
                Metadatos
              </h3>
              
              <div className="space-y-3 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-400">ID</span>
                  <span className="text-white font-mono text-xs">{vulnerability._id}</span>
                </div>
                {vulnerability.createdAt && (
                  <div className="flex justify-between">
                    <span className="text-gray-400">Creado</span>
                    <span className="text-white">
                      {new Date(vulnerability.createdAt).toLocaleDateString('es-ES')}
                    </span>
                  </div>
                )}
                {vulnerability.updatedAt && (
                  <div className="flex justify-between">
                    <span className="text-gray-400">Actualizado</span>
                    <span className="text-white">
                      {new Date(vulnerability.updatedAt).toLocaleDateString('es-ES')}
                    </span>
                  </div>
                )}
              </div>
            </Card>
          </div>
        </div>

        {/* Modal de confirmación de eliminación */}
        {deleteModal && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <Card className="w-full max-w-md">
              <div className="text-center">
                <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-danger-500/10 mb-4">
                  <AlertTriangle className="w-6 h-6 text-danger-400" />
                </div>
                <h3 className="text-lg font-semibold text-white mb-2">
                  Eliminar Vulnerabilidad
                </h3>
                <p className="text-gray-400 mb-6">
                  ¿Estás seguro de eliminar esta vulnerabilidad? Esta acción no se puede deshacer.
                </p>
                <div className="flex gap-3 justify-center">
                  <Button variant="ghost" onClick={() => setDeleteModal(false)}>
                    Cancelar
                  </Button>
                  <Button
                    variant="danger"
                    icon={Trash2}
                    onClick={handleDeleteConfirm}
                    loading={loading}
                  >
                    Eliminar
                  </Button>
                </div>
              </div>
            </Card>
          </div>
        )}
      </div>
    </div>
  );
};

export default VulnerabilityDetailPage;