const mongoose = require('mongoose');
const Schema = mongoose.Schema;

/**
 * Vulnerability Model
 * 
 * Define la estructura de vulnerabilidades en la base de conocimiento.
 * La lógica de negocio está en services/vulnerability.service.js
 */

/**
 * Esquema de campo personalizado
 */
const CustomFieldValueSchema = {
    _id: false,
    customField: { type: Schema.Types.ObjectId, ref: 'CustomField' },
    text: { type: Schema.Types.Mixed }
};

/**
 * Esquema de detalles de vulnerabilidad por locale
 */
const VulnerabilityDetailsSchema = {
    _id: false,
    locale: { type: String },
    title: { 
        type: String, 
        unique: true, 
        sparse: true,
        maxlength: [500, 'Title cannot exceed 500 characters']
    },
    vulnType: { type: String },
    description: { type: String },
    observation: { type: String },
    remediation: { type: String },
    references: [{ type: String }],
    customFields: [CustomFieldValueSchema]
};

/**
 * Estados de vulnerabilidad
 */
const VULNERABILITY_STATUS = {
    VALIDATED: 0,
    CREATED: 1,
    UPDATED: 2
};

/**
 * Esquema principal de Vulnerability
 */
const VulnerabilitySchema = new Schema({
    cvssv3: {
        type: String,
        maxlength: [255, 'CVSSv3 cannot exceed 255 characters']
    },
    cvssv4: {
        type: String,
        maxlength: [255, 'CVSSv4 cannot exceed 255 characters']
    },
    priority: {
        type: Number,
        enum: [1, 2, 3, 4]  // 1: Critical, 2: High, 3: Medium, 4: Low
    },
    remediationComplexity: {
        type: Number,
        enum: [1, 2, 3]  // 1: Low, 2: Medium, 3: High
    },
    details: [VulnerabilityDetailsSchema],
    status: {
        type: Number,
        enum: [0, 1, 2],  // 0: validated, 1: created, 2: updated
        default: 1
    },
    category: {
        type: String,
        maxlength: [255, 'Category cannot exceed 255 characters']
    },
    creator: {
        type: Schema.Types.ObjectId,
        ref: 'User'
    }
}, {
    timestamps: true,
    toJSON: {
        transform: function(doc, ret) {
            delete ret.__v;
            return ret;
        }
    }
});

/**
 * Índices
 */
VulnerabilitySchema.index({ 'details.title': 1 });
VulnerabilitySchema.index({ 'details.locale': 1 });
VulnerabilitySchema.index({ category: 1 });
VulnerabilitySchema.index({ status: 1 });
VulnerabilitySchema.index({ creator: 1 });

/**
 * Campos para exportación
 */
VulnerabilitySchema.statics.exportFields = 'details cvssv3 cvssv4 priority remediationComplexity category -_id';

/**
 * Constantes de estado
 */
VulnerabilitySchema.statics.STATUS = VULNERABILITY_STATUS;

const Vulnerability = mongoose.model('Vulnerability', VulnerabilitySchema);

module.exports = Vulnerability;
