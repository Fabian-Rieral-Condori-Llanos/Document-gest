const mongoose = require('mongoose');
const Schema = mongoose.Schema;

/**
 * VulnerabilityUpdate Model
 * 
 * Define actualizaciones propuestas para vulnerabilidades.
 * La lógica de negocio está en services/vulnerability-update.service.js
 */

/**
 * Esquema de campo personalizado
 */
const CustomFieldValueSchema = {
    _id: false,
    customField: { type: Schema.Types.ObjectId, ref: 'CustomField' },
    text: { type: Schema.Types.Mixed }
};

/**
 * Esquema principal de VulnerabilityUpdate
 */
const VulnerabilityUpdateSchema = new Schema({
    vulnerability: {
        type: Schema.Types.ObjectId,
        ref: 'Vulnerability',
        required: [true, 'Vulnerability reference is required']
    },
    creator: {
        type: Schema.Types.ObjectId,
        ref: 'User',
        required: [true, 'Creator is required']
    },
    cvssv3: {
        type: String,
        maxlength: [255, 'CVSSv3 cannot exceed 255 characters']
    },
    cvssv4: {
        type: String,
        maxlength: [255, 'CVSSv4 cannot exceed 255 characters']
    },
    priority: {
        type: Number,
        enum: [1, 2, 3, 4]
    },
    remediationComplexity: {
        type: Number,
        enum: [1, 2, 3]
    },
    references: [{ type: String }],
    locale: {
        type: String,
        maxlength: [10, 'Locale cannot exceed 10 characters']
    },
    title: {
        type: String,
        maxlength: [500, 'Title cannot exceed 500 characters']
    },
    vulnType: {
        type: String,
        maxlength: [255, 'Vulnerability type cannot exceed 255 characters']
    },
    description: { type: String },
    observation: { type: String },
    remediation: { type: String },
    category: {
        type: String,
        maxlength: [255, 'Category cannot exceed 255 characters']
    },
    customFields: [CustomFieldValueSchema]
}, {
    timestamps: true,
    toJSON: {
        transform: function(doc, ret) {
            delete ret.__v;
            return ret;
        }
    }
});

/**
 * Índices
 */
VulnerabilityUpdateSchema.index({ vulnerability: 1 });
VulnerabilityUpdateSchema.index({ creator: 1 });
VulnerabilityUpdateSchema.index({ createdAt: -1 });

const VulnerabilityUpdate = mongoose.model('VulnerabilityUpdate', VulnerabilityUpdateSchema);

module.exports = VulnerabilityUpdate;
